# Set the number of worker processes based on CPU cores.
worker_processes auto;

# Define the maximum number of connections per worker.
events {
    worker_connections 1024;
}

http {
    # Include standard mime types.
    include       mime.types;
    # Set default content type.
    default_type  application/octet-stream;
    # Enable efficient file serving.
    sendfile on;
    # Timeout for persistent connections.
    keepalive_timeout 65;

    #####################

    # Rate Limiting Setup
    # This limits each IP to an average of 10 requests per second,
    # with a burst capacity of 20 to allow for short traffic spikes.

    #####################

    limit_req_zone $binary_remote_addr zone=streamlit_limit:10m rate=10r/s;

    #####################

    # Logging Configuration
    # Define where to store access and error logs.

    #####################

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    #####################

    # Upstream Definition

    #

    # This defines the backend service (Streamlit app running in Docker).

    #####################

    upstream streamlit_backend {

        # "streamlit_app" is the Docker service name; adjust the port if necessary.

        server streamlit:8501;

    }



    #####################

    # HTTP Server Block

    #

    # This listens on port 80 and redirects all traffic to HTTPS.

    #####################

    server {
        listen 80;
        server_name 13.53.39.209;

    #####################

        # Proxy Timeout Settings
        # Increase timeouts to accommodate longer LLM response times.

        #####################

        proxy_connect_timeout 300;
        proxy_send_timeout    300;
        proxy_read_timeout    300;
        send_timeout          300;

        

        #####################

        # Location Block: Handling All Requests

        #

        # All incoming requests are forwarded to the Streamlit backend.

        #####################

        location / {

            # Apply rate limiting to protect against abuse.

            limit_req zone=streamlit_limit burst=20;

            # Forward requests to the streamlit backend (Docker Compose service name and port)

            proxy_pass http://streamlit_backend;

            # Required headers to support WebSocket connections and proper client IP forwarding.

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        }

    }

}

